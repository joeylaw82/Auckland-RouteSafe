name: ETL Data Pipeline and Pages Deployment

on:
  push:
    branches:
      - main  # åœ¨æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  workflow_dispatch: # å…è¨±æ‰‹å‹•å¾ GitHub Actions é é¢è§¸ç™¼

jobs:
  # Job 1: æ§‹å»º ETL æ•¸æ“š (é‹è¡Œ Python è…³æœ¬ä¸¦è¼¸å‡º GeoJSON/JSON)
  build-etl:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # å°‡ POLICE_DATA_URL Secret æ³¨å…¥åˆ°ç’°å¢ƒä¸­ï¼Œä¾› etl_master.py ä½¿ç”¨
      - name: Setup Environment Variables
        run: echo "POLICE_DATA_URL=${{ secrets.POLICE_DATA_URL }}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      # å®‰è£æ‰€æœ‰å¿…è¦çš„ä¾è³´
      - name: Install dependencies (GeoPandas, Pandas, Requests)
        run: |
          python -m pip install --upgrade pip
          # æ³¨æ„ï¼šgeopandas æœƒè‡ªå‹•å®‰è£å…¶ä¾è³´ (pandas, shapely, fiona, etc.)
          pip install pandas geopandas requests
          
      # é‹è¡Œ ETL è…³æœ¬ï¼Œç”Ÿæˆ GeoJSON å’Œ JSON è¼¸å‡ºæª”æ¡ˆåˆ° 'data' è³‡æ–™å¤¾
      - name: Run ETL Script (Generate GeoJSON/JSON in 'data' folder)
        run: python etl_master.py
        
      # é—œéµæ­¥é©Ÿï¼šä¸Šå‚³ç”Ÿæˆçš„ 'data' æ–‡ä»¶å¤¾ä½œç‚º Artifact
      - name: Upload ETL Data Artifact
        uses: actions/upload-artifact@v4
        with:
          name: etl-data-output
          path: data/
          
  # Job 2: éƒ¨ç½²åˆ° GitHub Pages (åªæœ‰åœ¨ Job 1 æˆåŠŸå¾Œæ‰æœƒé‹è¡Œ)
  deploy-pages:
    needs: build-etl # ä¾è³´æ–¼ build-etl Job
    runs-on: ubuntu-latest
    
    # ğŸ’¥ å¿…é ˆåŒ…å«æ­¤æ¬Šé™å€å¡Š ğŸ’¥
    permissions:
      contents: read     # å…è¨±è®€å– Artifacts å’Œä»£ç¢¼
      pages: write      # æˆäºˆå°‡æª”æ¡ˆå¯«å…¥ GitHub Pages æœå‹™çš„æ¬Šé™
      id-token: write   # å•Ÿç”¨ OIDC æ¬Šæ–ï¼Œç”¨æ–¼ä¿¡ä»»éƒ¨ç½²
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      # ä¸‹è¼‰åœ¨ Job 1 ä¸­å‰µå»ºçš„æ•¸æ“š Artifact
      - name: Download ETL Data Artifact
        uses: actions/download-artifact@v4
        with:
          name: etl-data-output
          path: data/ # ä¸‹è¼‰åˆ°æœ¬åœ°çš„ data è³‡æ–™å¤¾
          
      - name: Checkout Code (For deployment)
        uses: actions/checkout@v4
        
      # è¨­ç½® Pages ç’°å¢ƒï¼Œé€™æ˜¯éƒ¨ç½²çš„æ¨™æº–æ­¥é©Ÿ
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      # éƒ¨ç½²æ­¥é©Ÿï¼šå°‡æ‰€æœ‰å¿…è¦çš„æª”æ¡ˆç™¼ä½ˆåˆ° Pages æœå‹™
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          # å°‡å·¥ä½œç›®éŒ„çš„æ‰€æœ‰å…§å®¹ (index.html, data/) éƒ¨ç½²
          folder: .
