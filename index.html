<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auckland Bus Route Crime Analysis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* Basic styling for the map container */
        #map {
            height: 100vh;
            width: 75%; /* åœ°åœ–ä½” 75% å¯¬åº¦ */
            float: left;
        }
        /* Style for the sidebar/details panel */
        #route-details {
            height: 100vh;
            width: 25%; /* å´é‚Šæ¬„ä½” 25% å¯¬åº¦ */
            float: right;
            background-color: #f8f9fa;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto; /* å…è¨±å‚ç›´æ»¾å‹• */
            font-family: Arial, Helvetica, sans-serif;
            border-left: 1px solid #ddd;
        }
        #route-details h2 {
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            color: #007bff;
        }
        #route-details h3 {
            color: #333;
            margin-top: 15px;
            font-size: 1.1em;
        }
        #route-details ul {
            list-style: none;
            padding: 0;
        }
        #route-details li {
            padding: 3px 0;
            border-bottom: 1px dotted #eee;
        }
        /* Style for the information panel (top-right box on the map) */
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="route-details">
        <h2>è·¯ç·šè©³ç´°æ•¸æ“š</h2>
        <p id="details-status">é»æ“Šåœ°åœ–ä¸Šçš„å·´å£«è·¯ç·šä»¥æŸ¥çœ‹çŠ¯ç½ªäº‹ä»¶çš„æœˆåº¦è¶¨å‹¢å’Œé¡å‹ç´°åˆ†ã€‚</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20n6a329W8vB0V9B0o/1M+k9+8b6bB2/9wF/nF3D1C8="
            crossorigin=""></script>

    <script>
        // Global variable to store the crime breakdown data
        let crimeStatsData = null;

        // --- 1. Map Initialization ---
        // è¨­ç½®åœ°åœ–è¦–è§’åˆ°å¥§å…‹è˜­ä¸­å¿ƒ (Auckland: -36.8485, 174.7633)
        const map = L.map('map').setView([-36.8485, 174.7633], 12); 

        // æ·»åŠ åŸºç¤åœ°åœ–åœ–å±¤ (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // --- 2. æ¨£å¼å’Œé¡è‰²å‡½æ•¸ ---
        
        /**
         * æ ¹æ“šçŠ¯ç½ªç¸½æ•¸è¿”å›é¡è‰²å€¼ (é¡è‰²æ¼¸è®Š/è‰²æ¨™)
         */
        function getColor(d) {
            return d > 500 ? '#800026' : 
                   d > 200 ? '#BD0026' :
                   d > 100 ? '#E31A1C' :
                   d > 50  ? '#FC4E2A' :
                   d > 20  ? '#FD8D3C' :
                   d > 10  ? '#FEB24C' : 
                   d > 0   ? '#FED976' : 
                             '#CCCCCC'; 
        }

        /**
         * å®šç¾© GeoJSON åœ–å±¤çš„æ¨£å¼
         */
        function style(feature) {
            return {
                weight: 3,
                opacity: 0.9,
                color: getColor(feature.properties.Total_Crime_Count),
                fillOpacity: 0.7
            };
        }

        // --- 3. æ•¸æ“šåŠ è¼‰å’Œåœ°åœ–æ•´åˆ ---

        async function loadData() {
            try {
                // Fetch GeoJSON 
                const geoJsonUrl = 'data/route_crime_stats.geojson';
                const geoJsonResponse = await fetch(geoJsonUrl);
                const geoJsonData = await geoJsonResponse.json();

                // Fetch and store Stats JSON globally
                const statsJsonUrl = 'data/crime_breakdown.json';
                const statsJsonResponse = await fetch(statsJsonUrl);
                crimeStatsData = await statsJsonResponse.json();

                // Display Metadata
                displayMetadata(crimeStatsData.metadata);

                // Add GeoJSON Layer to Map
                L.geoJson(geoJsonData, {
                    style: style,
                    onEachFeature: function (feature, layer) {
                        const routeNo = feature.properties['Route No'];
                        const crimeCount = feature.properties.Total_Crime_Count;

                        // å‰µå»ºå½ˆå‡ºçª—å£å…§å®¹
                        const popupContent = `
                            <h4>ğŸšŒ å·´å£«è·¯ç·š: ${routeNo}</h4>
                            <p><strong>ç¸½çŠ¯ç½ªäº‹ä»¶æ•¸:</strong> ${crimeCount}</p>
                            <p>é»æ“Šè·¯ç·šä»¥åœ¨å´é‚Šæ¬„æŸ¥çœ‹è©³ç´°æ•¸æ“š</p>
                        `;
                        layer.bindPopup(popupContent);
                        
                        // ğŸ’¥ é—œéµï¼šæ·»åŠ é»æ“Šäº‹ä»¶ï¼Œèª¿ç”¨ showRouteDetails
                        layer.on({
                            click: function(e) {
                                showRouteDetails(routeNo, crimeCount);
                                // map.fitBounds(e.target.getBounds()); // å¯é¸ï¼šç¸®æ”¾åˆ°è¢«é»æ“Šçš„è·¯ç·š
                            },
                            mouseover: function(e) {
                                e.target.setStyle({weight: 6, color: '#00FFFF'});
                                e.target.bringToFront();
                            },
                            mouseout: function(e) {
                                L.geoJson.resetStyle(e.target);
                            }
                        });
                    }
                }).addTo(map);

            } catch (error) {
                console.error('Error loading GeoJSON or Stats JSON:', error);
                document.getElementById('map').innerHTML = '<div class="info" style="color: red; margin: 20px;"><h3>æ•¸æ“šåŠ è¼‰éŒ¯èª¤</h3>è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒã€‚ç¢ºä¿ data/route_crime_stats.geojson å’Œ data/crime_breakdown.json æª”æ¡ˆå·²æˆåŠŸéƒ¨ç½²ã€‚</div>';
            }
        }

        // --- 4. è·¯ç·šç´°ç¯€é¢æ¿å‡½æ•¸ ---

        function showRouteDetails(routeNo, totalCrimeCount) {
            const detailsDiv = document.getElementById('route-details');
            
            // å¦‚æœ JSON ä¸­æ²’æœ‰è©²è·¯ç·šçš„æ•¸æ“šï¼ˆå³è©²è·¯ç·šæ²’æœ‰çŠ¯ç½ªç™¼ç”Ÿï¼‰ï¼Œå‰‡ä½¿ç”¨ç¸½è¨ˆæ•¸é¡¯ç¤ºç°¡æ½”ä¿¡æ¯
            if (!crimeStatsData || !crimeStatsData.routes[routeNo]) {
                detailsDiv.innerHTML = `
                    <h2>ğŸšŒ è·¯ç·š: ${routeNo}</h2>
                    <p><strong>ç¸½çŠ¯ç½ªäº‹ä»¶æ•¸: ${totalCrimeCount}</strong></p>
                    <p style="color: gray;">ç„¡è©³ç´°çŠ¯ç½ªé¡å‹æˆ–æœˆåº¦è¶¨å‹¢æ•¸æ“šã€‚</p>
                `;
                return;
            }

            const routeData = crimeStatsData.routes[routeNo];
            
            // --- æ ¼å¼åŒ–æœˆåº¦è¶¨å‹¢ ---
            let trendList = '<ul>';
            // æŒ‰æœˆä»½/å¹´ä»½æ’åº
            const sortedTrends = Object.entries(routeData.monthly_trend).sort((a, b) => a[0].localeCompare(b[0]));
            if (sortedTrends.length > 0) {
                sortedTrends.forEach(([month, count]) => {
                    trendList += `<li><strong>${month}</strong>: ${count} æ¬¡äº‹ä»¶</li>`;
                });
            } else {
                trendList += '<li>ç„¡æœˆåº¦æ•¸æ“š</li>';
            }
            trendList += '</ul>';

            // --- æ ¼å¼åŒ–é¡å‹ç´°åˆ† ---
            let breakdownList = '<ul>';
            // æŒ‰è¨ˆæ•¸é™åºæ’åº
            const sortedBreakdown = Object.entries(routeData.type_breakdown).sort((a, b) => b[1] - a[1]);
            if (sortedBreakdown.length > 0) {
                sortedBreakdown.forEach(([type, count]) => {
                    breakdownList += `<li><strong>${type}</strong>: ${count} æ¬¡äº‹ä»¶</li>`;
                });
            } else {
                breakdownList += '<li>ç„¡é¡å‹ç´°åˆ†æ•¸æ“š</li>';
            }
            breakdownList += '</ul>';

            // --- æ¸²æŸ“åˆ°é¢æ¿ ---
            detailsDiv.innerHTML = `
                <h2>ğŸšŒ è·¯ç·š: ${routeNo}</h2>
                <p><strong>ç¸½çŠ¯ç½ªäº‹ä»¶æ•¸: ${totalCrimeCount}</strong></p>
                
                <h3>ğŸ“… æœˆåº¦è¶¨å‹¢ (Monthly Trend)</h3>
                ${trendList}
                
                <h3>ğŸš¨ çŠ¯ç½ªé¡å‹ç´°åˆ† (Type Breakdown)</h3>
                ${breakdownList}
            `;
        }


        // --- 5. å…ƒæ•¸æ“šé¢æ¿æ§åˆ¶ (ä¿æŒä¸è®Š) ---

        function displayMetadata(metadata) {
            const info = L.control({position: 'topright'});

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update(metadata);
                return this._div;
            };

            info.update = function (metadata) {
                this._div.innerHTML = `
                    <h4>ğŸšŒ å¥§å…‹è˜­å·´å£«è·¯ç·šçŠ¯ç½ªåˆ†æ</h4>
                    <b>åˆ†ææ™‚é–“ç¯„åœ:</b> ${metadata.crime_period_start} to ${metadata.crime_period_end}<br>
                    <b>ç·©è¡å€è·é›¢:</b> ${metadata.buffer_distance_m} å…¬å°º
                `;
            };

            info.addTo(map);
        }

        loadData();
    </script>
</body>
</html>
